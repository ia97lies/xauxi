SET KEEP_ALIVE=100
SET 1K=................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................
CLIENT $CONCURRENT
  _LOOP $KEEP_ALIVE
    _REQ localhost 8080
    __GET /test/1/foo HTTP/1.1
    __Connection: keep-alive
    __
    _EXPECT headers "200 OK"
    _EXPECT headers "[Ss]et-[Cc]ookie: session="
    _EXPECT body "AS1.*AS1"
    _WAIT
  _END
END

SERVER 9090 $CONCURRENT
  _MATH:EVAL "$KEEP_ALIVE - 1" KEEP_ALIVE
  _LOOP $KEEP_ALIVE
    _RES
    _EXPECT headers "GET /test/1/foo HTTP/1.1"
    _WAIT
    __HTTP/1.1 200 OK
    __Content-Length: AUTO
    __Set-Cookie: session=mysession
    __Connection: keep-alive
    __
    __AS1${1K}AS1
  _END

  _RES
  _EXPECT headers "GET /test/1/foo HTTP/1.1"
  _WAIT
  __HTTP/1.1 200 OK
  __Content-Length: AUTO
  __Set-Cookie: session=mysession
  __Connection: close 
  __
  __AS1${1K}AS1
  _CLOSE
END
